<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quality Evaluation of Scanned Documents</title>
  <style>
    .main {
      display: flex;
    }

    #dwtcontrolContainer {
      width: 240px;
      height: 320px;
    }

    .scanner {
      padding-right: 1em;
    }

    #hiddenImage{
      display: none;
    }
  </style>
</head>
<body>
  <div class="home">
    <h2>Quality Evaluation of Scanned Documents</h2>
    <div class="main">
      <div class="scanner">
        <button id="scanButton">Scan</button>
        <button id="loadButton">Load Files</button>
        <div id="dwtcontrolContainer"></div>
      </div>
      <div class="evaluation">
        <div class="DWTStatus status">Loading Dynamic Web TWAIN...</div>
        <div class="OpenCVStatus status">Loading OpenCV...</div>
        <div class="TesseractStatus status">Loading Tesseract...</div>
        <img id="hiddenImage"/>
        <button id="evaluateButton">Evaluate Selected Image</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/dwt@18.4.2/dist/dynamsoft.webtwain.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <script>
    let DWObject;
    Dynamsoft.DWT.AutoLoad = false;
    Dynamsoft.DWT.ProductKey = "DLS2eyJoYW5kc2hha2VDb2RlIjoiMjAwMDAxLTE2NDk4Mjk3OTI2MzUiLCJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSIsInNlc3Npb25QYXNzd29yZCI6IndTcGR6Vm05WDJrcEQ5YUoifQ=="; //one-day trial
    Dynamsoft.DWT.ResourcesPath = "https://unpkg.com/dwt@18.4.2/dist";
    
    window.onload = function(){
      initDWT();
      initTesseract();
      document.getElementById("scanButton").addEventListener("click",function(){
        AcquireImage();
      });
      document.getElementById("loadButton").addEventListener("click",function(){
        LoadFile();
      });
      document.getElementById("evaluateButton").addEventListener("click",function(){
        Evaluate();
      });
    }

    var Module = {
      // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
      onRuntimeInitialized() {
        document.getElementsByClassName("OpenCVStatus")[0].innerText = 'OpenCV.js is ready.';
      }
    };


    function LoadFile(){
      if (DWObject) {
        DWObject.IfShowFileDialog = true;
        // PDF Rasterizer Addon is used here to ensure PDF support
        DWObject.Addon.PDF.SetResolution(200);
        DWObject.Addon.PDF.SetConvertMode(Dynamsoft.DWT.EnumDWT_ConvertMode.CM_RENDERALL);
        DWObject.LoadImageEx("", Dynamsoft.DWT.EnumDWT_ImageType.IT_ALL);
      }
    }

    function AcquireImage() {
      if (DWObject) {
        DWObject.SelectSourceAsync()
        .then(function () {
          return DWObject.AcquireImageAsync({
            IfDisableSourceAfterAcquire: true,
          });
        })
        .then(function (result) {
          console.log(result);
        })
        .catch(function (exp) {
          console.error(exp.message);
        })
        .finally(function () {
          DWObject.CloseSourceAsync().catch(function (e) {
            console.error(e);
          });
        });
      }
    }

    function initDWT(){
      return new Promise((resolve, reject) => {
        const title = document.querySelector("h2").innerText;
        Dynamsoft.DWT.CreateDWTObjectEx(
        {
          WebTwainId: 'dwtcontrol'
        },
        function(obj) {
          document.getElementsByClassName("DWTStatus")[0].innerText = "Web TWAIN is Ready.";
          DWObject = obj;
          DWObject.Viewer.bind(document.getElementById('dwtcontrolContainer'));
          DWObject.Viewer.height = "100%";
          DWObject.Viewer.width = "100%";
          DWObject.Viewer.show();
          resolve();
        },
        function(err) {
          console.log(err);
          document.getElementsByClassName("DWTStatus")[0].innerText = "Failed to load Dynamic Web TWAIN";
          reject(err);
        }
      );
      })
    }

    async function initTesseract(){
      const worker = await Tesseract.createWorker("eng", 1, {
        logger: function(m){console.log(m);}
      });
      document.getElementsByClassName("TesseractStatus")[0].innerText = 'Tesseract is ready.';
    }

    async function Evaluate(){
      let img = await LoadImage();
      let isBlurry = DetectBlurriness(img);
      console.log(isBlurry);
    }

    function LoadImage(){
      return new Promise((resolve, reject) => {
        let img = document.getElementById("hiddenImage");
        img.onload = function(){
          resolve(img);
        }
        DWObject.ConvertToBase64(
            [DWObject.SelectedImagesIndices[0]],
            Dynamsoft.DWT.EnumDWT_ImageType.IT_PNG,
            function(result, indices, type) {
              img.src = "data:image/png;base64,"+result.getData(0, result.getLength());
            },
            function(errorCode, errorString) {
              console.log(errorString);
              reject(errorString);
            }
        );
      })
    }

    function DetectBlurriness(src){
      let img = cv.imread(src);

      let gray = new cv.Mat();
      cv.cvtColor(img, gray, cv.COLOR_RGBA2GRAY);

      let laplacianMat = new cv.Mat();
      cv.Laplacian(gray, laplacianMat, cv.CV_64F);
      const mean = new cv.Mat(1, 4, cv.CV_64F);
      const standardDeviationMat = new cv.Mat(1, 4, cv.CV_64F);
      cv.meanStdDev(laplacianMat, mean, standardDeviationMat);

      const standardDeviation = standardDeviationMat.doubleAt(0, 0);
      const variance = standardDeviation * standardDeviation;
      console.log(variance);
      let threshold = 200;
      let isBlurry = variance < threshold;
      img.delete();
      gray.delete();
      laplacianMat.delete();
      mean.delete();
      standardDeviationMat.delete();
      return isBlurry;
    }

    
  </script>
  <script async src="/opencv.js" type="text/javascript"></script>
</body>
</html>